RAWDATA=raw_data/Sample_C12_rep1/C12_rep1_CGATGT_L001_R1_001.fastq.gz raw_data/Sample_C12_rep1/C12_rep1_CGATGT_L001_R2_001.fastq.gz raw_data/Sample_C12_rep1/C12_rep1_CGATGT_L002_R1_001.fastq.gz raw_data/Sample_C12_rep1/C12_rep1_CGATGT_L002_R2_001.fastq.gz raw_data/Sample_C12_rep2/C12_rep2_TGACCA_L001_R1_001.fastq.gz raw_data/Sample_C12_rep2/C12_rep2_TGACCA_L001_R2_001.fastq.gz raw_data/Sample_C12_rep2/C12_rep2_TGACCA_L002_R1_001.fastq.gz raw_data/Sample_C12_rep2/C12_rep2_TGACCA_L002_R2_001.fastq.gz raw_data/Sample_C12_rep3/C12_rep3_ACAGTG_L001_R1_001.fastq.gz raw_data/Sample_C12_rep3/C12_rep3_ACAGTG_L001_R2_001.fastq.gz raw_data/Sample_C12_rep3/C12_rep3_ACAGTG_L002_R1_001.fastq.gz raw_data/Sample_C12_rep3/C12_rep3_ACAGTG_L002_R2_001.fastq.gz raw_data/Sample_C12_rep4/C12_rep4_GCCAAT_L001_R1_001.fastq.gz raw_data/Sample_C12_rep4/C12_rep4_GCCAAT_L001_R2_001.fastq.gz raw_data/Sample_C12_rep4/C12_rep4_GCCAAT_L002_R1_001.fastq.gz raw_data/Sample_C12_rep4/C12_rep4_GCCAAT_L002_R2_001.fastq.gz raw_data/Sample_C24_rep1/C24_rep1_ATCACG_L001_R1_001.fastq.gz raw_data/Sample_C24_rep1/C24_rep1_ATCACG_L001_R2_001.fastq.gz raw_data/Sample_C24_rep1/C24_rep1_ATCACG_L002_R1_001.fastq.gz raw_data/Sample_C24_rep1/C24_rep1_ATCACG_L002_R2_001.fastq.gz raw_data/Sample_C24_rep2/C24_rep2_TTAGGC_L001_R1_001.fastq.gz raw_data/Sample_C24_rep2/C24_rep2_TTAGGC_L001_R2_001.fastq.gz raw_data/Sample_C24_rep2/C24_rep2_TTAGGC_L002_R1_001.fastq.gz raw_data/Sample_C24_rep2/C24_rep2_TTAGGC_L002_R2_001.fastq.gz raw_data/Sample_C24_rep3/C24_rep3_ACTTGA_L001_R1_001.fastq.gz raw_data/Sample_C24_rep3/C24_rep3_ACTTGA_L001_R2_001.fastq.gz raw_data/Sample_C24_rep3/C24_rep3_ACTTGA_L002_R1_001.fastq.gz raw_data/Sample_C24_rep3/C24_rep3_ACTTGA_L002_R2_001.fastq.gz raw_data/Sample_C24_rep4/C24_rep4_GATCAG_L001_R1_001.fastq.gz raw_data/Sample_C24_rep4/C24_rep4_GATCAG_L001_R2_001.fastq.gz raw_data/Sample_C24_rep4/C24_rep4_GATCAG_L002_R1_001.fastq.gz raw_data/Sample_C24_rep4/C24_rep4_GATCAG_L002_R2_001.fastq.gz raw_data/Sample_E12_rep1/E12_rep1_CAGATC_L001_R1_001.fastq.gz raw_data/Sample_E12_rep1/E12_rep1_CAGATC_L001_R2_001.fastq.gz raw_data/Sample_E12_rep1/E12_rep1_CAGATC_L002_R1_001.fastq.gz raw_data/Sample_E12_rep1/E12_rep1_CAGATC_L002_R2_001.fastq.gz raw_data/Sample_E12_rep2/E12_rep2_CTTGTA_L001_R1_001.fastq.gz raw_data/Sample_E12_rep2/E12_rep2_CTTGTA_L001_R2_001.fastq.gz raw_data/Sample_E12_rep2/E12_rep2_CTTGTA_L002_R1_001.fastq.gz raw_data/Sample_E12_rep2/E12_rep2_CTTGTA_L002_R2_001.fastq.gz raw_data/Sample_E12_rep3/E12_rep3_AGTCAA_L001_R1_001.fastq.gz raw_data/Sample_E12_rep3/E12_rep3_AGTCAA_L001_R2_001.fastq.gz raw_data/Sample_E12_rep3/E12_rep3_AGTCAA_L002_R1_001.fastq.gz raw_data/Sample_E12_rep3/E12_rep3_AGTCAA_L002_R2_001.fastq.gz raw_data/Sample_E12_rep4/E12_rep4_AGTTCC_L001_R1_001.fastq.gz raw_data/Sample_E12_rep4/E12_rep4_AGTTCC_L001_R2_001.fastq.gz raw_data/Sample_E12_rep4/E12_rep4_AGTTCC_L002_R1_001.fastq.gz raw_data/Sample_E12_rep4/E12_rep4_AGTTCC_L002_R2_001.fastq.gz raw_data/Sample_E24_rep1/E24_rep1_TAGCTT_L001_R1_001.fastq.gz raw_data/Sample_E24_rep1/E24_rep1_TAGCTT_L001_R2_001.fastq.gz raw_data/Sample_E24_rep1/E24_rep1_TAGCTT_L002_R1_001.fastq.gz raw_data/Sample_E24_rep1/E24_rep1_TAGCTT_L002_R2_001.fastq.gz raw_data/Sample_E24_rep2/E24_rep2_GGCTAC_L001_R1_001.fastq.gz raw_data/Sample_E24_rep2/E24_rep2_GGCTAC_L001_R2_001.fastq.gz raw_data/Sample_E24_rep2/E24_rep2_GGCTAC_L002_R1_001.fastq.gz raw_data/Sample_E24_rep2/E24_rep2_GGCTAC_L002_R2_001.fastq.gz raw_data/Sample_E24_rep3/E24_rep3_GTGGCC_L001_R1_001.fastq.gz raw_data/Sample_E24_rep3/E24_rep3_GTGGCC_L001_R2_001.fastq.gz raw_data/Sample_E24_rep3/E24_rep3_GTGGCC_L002_R1_001.fastq.gz raw_data/Sample_E24_rep3/E24_rep3_GTGGCC_L002_R2_001.fastq.gz raw_data/Sample_E24_rep4/E24_rep4_GTTTCG_L001_R1_001.fastq.gz raw_data/Sample_E24_rep4/E24_rep4_GTTTCG_L001_R2_001.fastq.gz raw_data/Sample_E24_rep4/E24_rep4_GTTTCG_L002_R1_001.fastq.gz raw_data/Sample_E24_rep4/E24_rep4_GTTTCG_L002_R2_001.fastq.gz raw_data/Sample_T12_rep1/T12_rep1_ATGTCA_L001_R1_001.fastq.gz raw_data/Sample_T12_rep1/T12_rep1_ATGTCA_L001_R2_001.fastq.gz raw_data/Sample_T12_rep1/T12_rep1_ATGTCA_L002_R1_001.fastq.gz raw_data/Sample_T12_rep1/T12_rep1_ATGTCA_L002_R2_001.fastq.gz raw_data/Sample_T12_rep2/T12_rep2_CCGTCC_L001_R1_001.fastq.gz raw_data/Sample_T12_rep2/T12_rep2_CCGTCC_L001_R2_001.fastq.gz raw_data/Sample_T12_rep2/T12_rep2_CCGTCC_L002_R1_001.fastq.gz raw_data/Sample_T12_rep2/T12_rep2_CCGTCC_L002_R2_001.fastq.gz raw_data/Sample_T12_rep3/T12_rep3_GTCCGC_L001_R1_001.fastq.gz raw_data/Sample_T12_rep3/T12_rep3_GTCCGC_L001_R2_001.fastq.gz raw_data/Sample_T12_rep3/T12_rep3_GTCCGC_L002_R1_001.fastq.gz raw_data/Sample_T12_rep3/T12_rep3_GTCCGC_L002_R2_001.fastq.gz raw_data/Sample_T12_rep4/T12_rep4_GTGAAA_L001_R1_001.fastq.gz raw_data/Sample_T12_rep4/T12_rep4_GTGAAA_L001_R2_001.fastq.gz raw_data/Sample_T12_rep4/T12_rep4_GTGAAA_L002_R1_001.fastq.gz raw_data/Sample_T12_rep4/T12_rep4_GTGAAA_L002_R2_001.fastq.gz raw_data/Sample_T24_rep1/T24_rep1_CGTACG_L001_R1_001.fastq.gz raw_data/Sample_T24_rep1/T24_rep1_CGTACG_L001_R2_001.fastq.gz raw_data/Sample_T24_rep1/T24_rep1_CGTACG_L002_R1_001.fastq.gz raw_data/Sample_T24_rep1/T24_rep1_CGTACG_L002_R2_001.fastq.gz raw_data/Sample_T24_rep2/T24_rep2_GAGTGG_L001_R1_001.fastq.gz raw_data/Sample_T24_rep2/T24_rep2_GAGTGG_L001_R2_001.fastq.gz raw_data/Sample_T24_rep2/T24_rep2_GAGTGG_L002_R1_001.fastq.gz raw_data/Sample_T24_rep2/T24_rep2_GAGTGG_L002_R2_001.fastq.gz raw_data/Sample_T24_rep3/T24_rep3_ACTGAT_L001_R1_001.fastq.gz raw_data/Sample_T24_rep3/T24_rep3_ACTGAT_L001_R2_001.fastq.gz raw_data/Sample_T24_rep3/T24_rep3_ACTGAT_L002_R1_001.fastq.gz raw_data/Sample_T24_rep3/T24_rep3_ACTGAT_L002_R2_001.fastq.gz raw_data/Sample_T24_rep4/T24_rep4_ATTCCT_L001_R1_001.fastq.gz raw_data/Sample_T24_rep4/T24_rep4_ATTCCT_L001_R2_001.fastq.gz raw_data/Sample_T24_rep4/T24_rep4_ATTCCT_L002_R1_001.fastq.gz raw_data/Sample_T24_rep4/T24_rep4_ATTCCT_L002_R2_001.fastq.gz

#Small set of data files used for testing
#RAWDATA=raw_data/Sample_C12_rep1/C12_rep1_CGATGT_L001_R1_001.fastq.gz raw_data/Sample_C12_rep1/C12_rep1_CGATGT_L001_R2_001.fastq.gz raw_data/Sample_C12_rep1/C12_rep1_CGATGT_L002_R1_001.fastq.gz raw_data/Sample_C12_rep1/C12_rep1_CGATGT_L002_R2_001.fastq.gz raw_data/Sample_C12_rep2/C12_rep2_TGACCA_L001_R1_001.fastq.gz raw_data/Sample_C12_rep2/C12_rep2_TGACCA_L001_R2_001.fastq.gz raw_data/Sample_C12_rep2/C12_rep2_TGACCA_L002_R1_001.fastq.gz raw_data/Sample_C12_rep2/C12_rep2_TGACCA_L002_R2_001.fastq.gz

#QC raw data - do this pre-concatenation to check for lane issues

QC_OUTDIR=fastqc_out
QC_RAW_OUTDIR=$(addsuffix /raw, $(QC_OUTDIR))

qc_out:
	mkdir $(QC_OUTDIR)

qc_raw_out: qc_out
	mkdir $(QC_RAW_OUTDIR)

qc_raw: $(RAWDATA) qc_raw_out
	fastqc -o $(QC_RAW_OUTDIR) -t $(words $(RAWDATA))  $(RAWDATA)

qc_clean: $(QC_OUTDIR)
	rm -r $(QC_OUTDIR)

#Concatenate raw data files over lanes
#
#Because some programs do not handle gzipped fastq, decompres at this point

DATADIRS=$(dir $(RAWDATA))
BASENAMES=$(sort $(subst /, , $(subst raw_data/Sample_, , $(DATADIRS))))
CONCAT_BASE=concatenated_raw/
CONCAT_DIRS=$(addprefix $(CONCAT_BASE), $(BASENAMES)) 
CONCAT_FILES=$(join $(addsuffix /, $(CONCAT_DIRS)), $(addsuffix _R1.fastq, $(BASENAMES)))
CONCAT_FILES+=$(join $(addsuffix /, $(CONCAT_DIRS)), $(addsuffix _R2.fastq, $(BASENAMES)))


$(CONCAT_FILES): $(RAWDATA)
	if [ ! -d $(CONCAT_BASE) ]; then mkdir $(CONCAT_BASE); fi
	for d in $(CONCAT_DIRS); do \
		if [ ! -d $$d ]; then mkdir $$d; fi; \
	done
	for b in $(BASENAMES); do \
		zcat raw_data/Sample_$$b/$$b*R1*.fastq.gz > concatenated_raw/$$b/$$b\_R1.fastq; \
		zcat raw_data/Sample_$$b/$$b*R2*.fastq.gz > concatenated_raw/$$b/$$b\_R2.fastq; \
	done

concat_raw: $(CONCAT_FILES)

concat_clean: $(CONCAT_BASE)
	rm -r $(CONCAT_BASE)

#Check that concatenated files are still correctly paired

PAIR_CHECK_FILE=$(addprefix $(CONCAT_BASE), pairingcheck.txt)

$(PAIR_CHECK_FILE): $(CONCAT_FILES)
	if [ -f $(PAIR_CHECK_FILE) ]; then rm $(PAIR_CHECK_FILE); fi; \
	for sample in $(BASENAMES); do \
		echo $$sample >> $(PAIR_CHECK_FILE); \
		pe-sync-2-files.pl $(CONCAT_BASE)/$$sample/*.fastq >> $(PAIR_CHECK_FILE); \
	done

concat_check: $(PAIR_CHECK_FILE)

#
# Use trimmomatic to remove adaptors and low quality regions
#

#Set up the input and output files. This gets a little messy because of the number of
#files. Would be nice to use trimmomatics -basein and -baseout options by the rules
#used to parse these are not well documented. 

R1IN=$(join $(addsuffix /, $(CONCAT_DIRS)), $(addsuffix _R1.fastq, $(BASENAMES)))
R2IN=$(join $(addsuffix /, $(CONCAT_DIRS)), $(addsuffix _R2.fastq, $(BASENAMES)))

TRIM_BASE=trimmed/
TRIM_DIRS=$(addprefix $(TRIM_BASE), $(BASENAMES)) 

#Paired output
1POUT=$(join $(addsuffix /, $(TRIM_DIRS)), $(addsuffix _R1_P.fastq, $(BASENAMES)))
2POUT=$(join $(addsuffix /, $(TRIM_DIRS)), $(addsuffix _R2_P.fastq, $(BASENAMES)))

#Unpaired output
1UOUT=$(join $(addsuffix /, $(TRIM_DIRS)), $(addsuffix _R1_U.fastq, $(BASENAMES)))
2UOUT=$(join $(addsuffix /, $(TRIM_DIRS)), $(addsuffix _R2_U.fastq, $(BASENAMES)))

TRIM_FILES=$(1POUT) $(2POUT) $(1UOUT) $(2UOUT)

TRIM_CMD=java -jar /usr/local/Trimmomatic-0.36/trimmomatic-0.36.jar PE

###################################
#                                 #
# Adjust trimmomatic options here #
#                                 #
###################################
TRIM_OPS=ILLUMINACLIP:/usr/local/Trimmomatic-0.36/adapters/TruSeq3-PE-2.fa:3:25:7 SLIDINGWINDOW:6:20 MINLEN:40

$(TRIM_FILES): $(CONCAT_FILES)
	if [ ! -d $(TRIM_BASE) ]; then mkdir $(TRIM_BASE); fi
	for d in $(TRIM_DIRS); do \
		if [ ! -d $$d ]; then mkdir $$d; fi; \
	done;
	$(foreach sample, $(BASENAMES), $(TRIM_CMD) $(filter concatenated_raw/$(sample)%, $(R1IN)) $(filter concatenated_raw/$(sample)%, $(R2IN)) $(filter trimmed/$(sample)%, $(1POUT)) $(filter trimmed/$(sample)%, $(1UOUT)) $(filter trimmed/$(sample)%, $(2POUT)) $(filter trimmed/$(sample)%, $(2UOUT)) $(TRIM_OPS);)


trim: $(TRIM_FILES)

trim_clean: $(TRIM_BASE)
	rm -r $(TRIM_BASE)


#
# Run QC on trimmed data
#

QC_TRIMMED_OUTDIR=$(addsuffix /trimmed, $(QC_OUTDIR))

qc_trimmed: $(TRIM_FILES)
	if [ ! -d $(QC_OUTDIR) ]; then mkdir $(QC_OUTDIR); fi
	if [ ! -d $(QC_TRIMMED_OUTDIR) ]; then mkdir $(QC_TRIMMED_OUTDIR); fi
	fastqc -o $(QC_TRIMMED_OUTDIR) -t $(words $(TRIM_FILES))  $(TRIM_FILES)

